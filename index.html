<!DOCTYPE html>
<html>

<head>
    <title>Maps</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"
        type="text/javascript"></script>
    <!-- <script src="mqtt.js"></script> -->
    <!-- <link rel="stylesheet" type="text/css" href="static/stylesheet.css'"> -->

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
        integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin="" />
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
        integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
        crossorigin=""></script>

    <script type="text/javascript">


        function onConnectionLost() {
            console.log("connection lost");
            document.getElementById("status").innerHTML = "Connection Lost";
            document.getElementById("status_messages").innerHTML = "Connection Lost";
            connected_flag = 0;
        }
        function onFailure(message) {
            console.log("Failed");
            document.getElementById("status_messages").innerHTML = "Connection Failed- Retrying";
            setTimeout(MQTTconnect, reconnectTimeout);
        }
        function onMessageArrived(r_message) {
            out_msg = "Message received " + r_message.payloadString;
            out_msg = out_msg + "      Topic " + r_message.destinationName + "<br/>";
            out_msg = "<b>" + out_msg + "</b>";
            //console.log(out_msg+row);
            try {
                document.getElementById("out_messages").innerHTML += out_msg;
            }
            catch (err) {
                document.getElementById("out_messages").innerHTML = err.message;
            }

            if (row == 10) {
                row = 1;
                document.getElementById("out_messages").innerHTML = out_msg;
            }
            else
                row += 1;

            mcount += 1;
            console.log(mcount + "  " + row);
        }

        function onConnected(recon, url) {
            console.log(" in onConnected " + reconn);
        }
        function onConnect() {
            // Once a connection has been made, make a subscription and send a message.
            document.getElementById("status_messages").innerHTML = "Connected to " + host + "on port " + port;
            connected_flag = 1;
            document.getElementById("status").innerHTML = "Connected";
            console.log("on Connect " + connected_flag);

        }
        function disconnect() {
            if (connected_flag == 1)
                mqtt.disconnect();
        }

        function MQTTconnect() {
            var clean_sessions = document.forms["connform"]["clean_sessions"].value;
           
            console.log("clean= " + clean_sessions);
           

            if (clean_sessions = document.forms["connform"]["clean_sessions"].checked)
                clean_sessions = true
            else
                clean_sessions = false

            document.getElementById("status_messages").innerHTML = "";
            var s = document.forms["connform"]["server"].value;
            var p = document.forms["connform"]["port"].value;
            if (p != "") {
                port = parseInt(p);
            }
            if (s != "") {
                host = s;
                console.log("host");
            }

            console.log("connecting to " + host + " " + port + "clean session=" + clean_sessions);
            console.log("user " + user_name);
            document.getElementById("status_messages").innerHTML = 'connecting';
            var x = Math.floor(Math.random() * 10000);
            var cname = "orderform-" + x;
            mqtt = new Paho.MQTT.Client(host, port, cname);
            //document.write("connecting to "+ host);
            var options = {
                timeout: 3,
                cleanSession: clean_sessions,
                onSuccess: onConnect,
                onFailure: onFailure,

            };
            
            mqtt.onConnectionLost = onConnectionLost;
            mqtt.onMessageArrived = onMessageArrived;
            mqtt.onConnected = onConnected;

            mqtt.connect(options);
            return false;


        }
        function sub_topics() {
            document.getElementById("status_messages").innerHTML = "";
            if (connected_flag == 0) {
                out_msg = "<b>Not Connected so can't subscribe</b>"
                console.log(out_msg);
                document.getElementById("status_messages").innerHTML = out_msg;
                return false;
            }
            var stopic = document.forms["subs"]["Stopic"].value;
            console.log("here");
            var sqos = parseInt(document.forms["subs"]["sqos"].value);
            if (sqos > 2)
                sqos = 0;
            console.log("Subscribing to topic =" + stopic + " QOS " + sqos);
            document.getElementById("status_messages").innerHTML = "Subscribing to topic =" + stopic;
            var soptions = {
                qos: sqos,
            };
            mqtt.subscribe(stopic, soptions);
            return false;
        }
        function send_message() {
            document.getElementById("status_messages").innerHTML = "";
            if (connected_flag == 0) {
                out_msg = "<b>Not Connected so can't send</b>"
                console.log(out_msg);
                document.getElementById("status_messages").innerHTML = out_msg;
                return false;
            }
           ;
            var msg = document.forms["smessage"]["message"].value;
            console.log(msg);
            document.getElementById("status_messages").innerHTML = "Sending message  " + msg;

            var topic = document.forms["smessage"]["Ptopic"].value;
            //var retain_message = document.forms["smessage"]["retain"].value;
            if (document.forms["smessage"]["retain"].checked)
                retain_flag = true;
            else
                retain_flag = false;
            message = new Paho.MQTT.Message(msg);
            if (topic == "")
                message.destinationName = "test-topic";
            else
                message.destinationName = topic;
            message.qos = pqos;
            message.retained = retain_flag;
            mqtt.send(message);
            return false;
        }


    </script>

    <style>
        #mapid {
            height: 400px;
            width: 425px;
        }

        .navbar {
            justify-content: center;

        }

        body {
            background-color: aqua;
        }
    </style>
</head>

<body>



    <br>
<table>
<tr>

<td id="connect" width="300" >

	 <form name="connform" action="" onsubmit="return MQTTconnect()">

Server:  <input type="text" name="server"><br><br>
Port:    <input type="text" name="port"><br><br>
Clean Session: <input type="checkbox" name="clean_sessions" value="true" checked><br><br>

<input name="conn" type="submit" value="Connect">
<input TYPE="button" name="discon " value="DisConnect" onclick="disconnect()">
</form>
</td>
<td id="subscribe" width="300">
<form name="subs" action="" onsubmit="return sub_topics()">
Subscribe Topic:   <input type="text" name="Stopic"><br>
Subscribe QOS:   <input type="text" name="sqos" value="0"><br>
<input type="submit" value="Subscribe">
</form> 
</td>
<td id="publish" width="300">
<form name="smessage" action="" onsubmit="return send_message()">

Message: <input type="text" name="message"><br><br>
Publish Topic:   <input type="text" name="Ptopic"><br><br>
Publish QOS:   <input type="text" name="pqos" value="0"><br>
Retain Message:   <input type="checkbox" name="retain" value="true" ><br>
<input type="submit" value="Submit">
</form>
</td>
</tr>
</table>
Status Messages:
<div id="status_messages">
</div>
Received Messages:

<div id="out_messages">
</div>
	<script>
	var connected_flag=0	
	var mqtt;
    var reconnectTimeout = 2000;
	var host="192.168.1.157";
	var port=9001;
	var row=0;
	var out_msg="";
	var mcount=0;
	</script>
    <div class="container-fluid justify-content-center" id="mapid">


        <script>
            var map = L.map('mapid').setView([51.04, -114.05], 10);

            L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox/streets-v11',
                tileSize: 512,
                zoomOffset: -1,
                accessToken: 'pk.eyJ1IjoibW1hcnIiLCJhIjoiY2tsaDloN3diMGswNjJ2cXBxNXlnODdieSJ9.SpAD42Te3ZwK3j0C46fyMA'
            }).addTo(map);

        </script>
    </div>

</body>

</html>